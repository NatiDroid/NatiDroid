import os
import json

def get_file(base, extension):
    list = []
    for root, ds, fs in os.walk(base):
        for f in fs:
            if f.endswith(extension):
                fullname = os.path.join(root, f)
                list.append(fullname)
    return list

def extract_from_apk():
    base = '/mal/APK/malware16171819'
    files = get_file(base, '.apk')

    total = len(files)
    for i, apk in enumerate(files):
        if i<3557:
            continue
        if not os.path.exists('log/%i_%i' % (i, total)):
            os.mkdir('log/%i_%i' % (i, total))
        print(i, '/', total)
        cmd = 'java -jar apkreflect.jar -android-jars android-platforms-master -process-dir %s -process-multiple-dex' % apk
        print(cmd)
        os.system(cmd)


def match_reflection():
    base = 'apk_reflect/'
    files = get_file(base, '.txt')
    unique = []
    unique_list = []
    with open('csv/Java_permission.json', 'r') as file_obj:
        json_list = json.load(file_obj)
        json_list = json_list['array']
        for tem in json_list:
            if (tem['class_name'] + tem['method_name']) not in unique:
                unique_list.append(tem)
                unique.append(tem['class_name'] + tem['method_name'])

    save_json = []
    total = len(files)
    for i, file in enumerate(files):
        print(i, '/', total)
        with open(file, 'r') as file_obj:
            for line in file_obj:
                # com.skymobi.pay.maxture.MaxturePaySDK: getInstance
                for tem in unique_list:
                    if tem['class_name'] in line and tem['method_name'].replace('(', '') in line:
                        save_json.append({'apk': file, 'class_name': tem['class_name'], 'method_name': tem['method_name']})
                        print({'apk': file, 'class_name': tem['class_name'], 'method_name': tem['method_name']})
    print(save_json)
    with open('tem/reflection_resutlt/reflection_resutlt.json', 'w') as file_obj:
        json.dump({"array": save_json}, file_obj)

def api_analyze():
    list_camera = []
    base = 'apk_api_1st_version/'
    files = get_file(base, '.txt')

    times = {}
    with open('csv/Java_permission.json', 'r') as file_obj:
        json_list = json.load(file_obj)
        json_list = json_list['array']
        for tem in json_list:
            key = tem['class_name'] + ':' + tem['method_name']
            if (key) not in times.keys():
                times[key] = 1
            else:
                times[key] = times[key] + 1
    print(times)

    dic = {}
    total = len(files)
    for i, file in enumerate(files):
        print(i, '/', total)
        with open(file, 'r') as file_obj:
            for line in file_obj:
                key = line.split('|')[0]
                if 'android.media.MediaPlayer:setDataSource(' in key:
                    list_camera.append([line, file])
                if key in dic.keys():
                    dic[key] = dic[key] + 1
                else:
                    dic[key] = 0

    for k in dic.keys():
        dic[k] = (int)(dic[k] / times[k])
    print(dic)
    with open('tem/apk_api_resutlt/apk_api_resutlt.json', 'w') as file_obj:
        json.dump({"array": dic}, file_obj)

    print(list_camera)
